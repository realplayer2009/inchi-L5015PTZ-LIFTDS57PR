#!/bin/bash
# postinst script for inchiptz
# 安装后执行的脚本

set -e

case "$1" in
    configure)
        # 创建日志目录
        if [ ! -d /var/log/inchiptz ]; then
            mkdir -p /var/log/inchiptz
            chmod 755 /var/log/inchiptz
        fi
        
        # 设置日志文件权限
        touch /var/log/inchiptz/operation.log
        touch /var/log/inchiptz/error.log
        chmod 644 /var/log/inchiptz/operation.log
        chmod 644 /var/log/inchiptz/error.log
        
        # 添加当前用户到dialout组（用于访问串口设备）
        if [ -n "$SUDO_USER" ]; then
            usermod -a -G dialout $SUDO_USER
            echo "已将用户 $SUDO_USER 添加到 dialout 组"
        fi
        
        # 重新加载systemd配置
        systemctl daemon-reload
        
        # 安装 Python 依赖
        echo "正在安装 Python 依赖包..."
        pip3 install --upgrade pip setuptools wheel 2>/dev/null || true
        pip3 install pymodbus pyserial flask 2>/dev/null || \
        pip3 install pymodbus pyserial flask --break-system-packages 2>/dev/null || \
        python3 -m pip install pymodbus pyserial flask 2>/dev/null || true
        
        if ! python3 -c "import flask, serial" 2>/dev/null; then
            echo "警告: Python 依赖安装可能未完成，请手动运行:"
            echo "  sudo pip3 install pymodbus pyserial flask"
            echo ""
        fi
        
        # 启用服务（开机自启动）
        systemctl enable inchiptz.service
        
        echo ""
        echo "====================================="
        echo "InchiPTZ API Server 安装完成"
        echo "====================================="
        echo ""
        echo "服务配置:"
        echo "  通信地址: 192.168.25.78:502 (TCP)"
        echo "  API 监听: 0.0.0.0:50278"
        echo ""
        echo "使用以下命令管理服务:"
        echo "  启动服务: sudo systemctl start inchiptz"
        echo "  停止服务: sudo systemctl stop inchiptz"
        echo "  查看状态: sudo systemctl status inchiptz"
        echo "  查看日志: sudo journalctl -u inchiptz -f"
        echo ""
        echo "操作日志: /var/log/inchiptz/operation.log"
        echo "错误日志: /var/log/inchiptz/error.log"
        echo ""
        echo "API端点: http://0.0.0.0:50278"
        echo "  POST /set_position - 设置PTZ位置"
        echo "  GET  /get_status   - 获取PTZ状态"
        echo "  GET  /health       - 健康检查"
        echo ""
        echo "测试命令:"
        echo "  curl http://localhost:50278/health"
        echo "====================================="
        ;;
    
    abort-upgrade|abort-remove|abort-deconfigure)
        ;;
    
    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
        ;;
esac

exit 0
